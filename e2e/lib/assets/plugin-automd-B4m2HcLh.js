import"./style-DeZY9Jm1.js";import{j as M,c as R,p as v,T as P,$ as E,P as b,a as O,o as _,d as L,E as F,r as j,n as q,f as H,q as W}from"./utils-CZPcvWg1.js";import{l as z,a as K}from"./index-CoqkUwom.js";import{g as B,m as D}from"./index-qPJtBnVo.js";import{m as G,a as U}from"./index-Do58SB3i.js";import"./default-0Dp3JUBc.js";const V=(...e)=>{const t=e.length;let o=t;for(;o--;)if(typeof e[o]!="function")throw new TypeError("Expected a function");return(...n)=>{let l=0,s=t?e[l](...n):n[0];for(;++l<t;)s=e[l](s);return s}};function A(e,t){return Object.assign(e,{meta:{package:"@milkdown/plugin-automd",...t}}),e}const Y=/\[([^\]]+)]\([^\s\]]+\)/,k=/\[(?<span>((www|https:\/\/|http:\/\/)[^\s\]]+))]\((?<url>[^\s\]]+)\)/;function Z(e){return new RegExp(`\\\\(?=[^\\w\\s${e}\\\\]|_)`,"g")}const y="​",x=`${y}*`,w=`${y}＊`,C=`${y}_`,N=`${y}⎽`;function J(e){let t=e,o=t.match(k);for(;o&&o.groups;){const{span:n}=o.groups;t=t.replace(k,n),o=t.match(k)}return t}function Q(e){return e.replaceAll(/\\\\\*/g,x).replaceAll(/\\\\_/g,C).replaceAll(x,w).replaceAll(C,N)}function X(e,t,o){const n=e.split(""),l=n[t];return n[t]&&n[o]&&(n[t]=n[o],n[o]=l),n.join("").toString()}function ee(e){return t=>t.replace(Z(e),"")}function te(e){return t=>{const o=t.indexOf(e.hole),n=t.charAt(o-1),l=t.charAt(o+1),s=/[^\w]|_/;return l?n&&s.test(n)&&s.test(l)?e.punctuation:e.char:e.punctuation}}function ne(e,t,o){let n=t,l=!1;return e.descendants(s=>{var a;if(l)return!1;if(!s.textContent.includes(o))return n+=s.nodeSize,!1;if(s.isText){const r=(a=s.text)==null?void 0:a.indexOf(o);if(r!=null&&r>=0)return l=!0,n+=r,!1}return n+=1,!0}),n}const oe={placeholderConfig:{hole:"∅",punctuation:"⁂",char:"∴"},globalNodes:["footnote_definition"],shouldSyncNode:({prevNode:e,nextNode:t})=>e.inlineContent&&t&&e.type===t.type&&!e.eq(t),movePlaceholder:(e,t)=>{const o=["*","_"];let n=t.indexOf(e);for(;o.includes(t[n-1]||"")&&o.includes(t[n+1]||"");)t=X(t,n,n+1),n=n+1;return t}},h=M(oe,"inlineSyncConfig");A(h,{displayName:"Ctx<inlineSyncConfig>",group:"Prose"});function re(e){return e.selection.$from.node()}function le(e,t,o,n){const l=e.get(R),s=t.schema.topNodeType.create(void 0,[o,...n]);return l(s)}function se(e,t){const o=e.get(h.key),n=o.placeholderConfig.hole,[l="",...s]=t.split(`

`),a=u=>o.movePlaceholder(n,u);let i=V(ee(n),a,J,Q)(l);const c=te(o.placeholderConfig)(i);return i=i.replace(n,c),i=[i,...s].join(`

`),[i,c]}function ie(e,t){const n=e.get(v)(t);return n?n.firstChild:null}function ce(e,t){const{globalNodes:o}=e.get(h.key),n=[];return t.doc.descendants(l=>{if(o.includes(l.type.name)||o.includes(l.type))return n.push(l),!1}),n}const ae=e=>e.split(`

`)[0]||"";function ue(e){return e.childCount===1&&e.child(0).type.name==="html"}function T(e,t){try{const o=ce(e,t),n=re(t),l=le(e,t,n,o),[s,a]=se(e,l),r=ie(e,s);return!r||n.type!==r.type||ue(r)?null:(r.attrs={...n.attrs},r.descendants(i=>{var p,d,m;const u=i.marks.find(f=>f.type.name==="link");u&&((p=i.text)!=null&&p.includes(a))&&u.attrs.href.includes(a)&&(u.attrs.href=u.attrs.href.replace(a,"")),((d=i.text)!=null&&d.includes(w)||(m=i.text)!=null&&m.includes(N))&&(i.text=i.text.replaceAll(w,x).replaceAll(N,C))}),{text:ae(s),prevNode:n,nextNode:r,placeholder:a})}catch{return null}}function de(e,t,o,n,l){var g;const{placeholderConfig:s}=e.get(h.key),a=s.hole;let r=o.tr.setMeta(t,!0).insertText(a,o.selection.from);const i=o.apply(r),c=T(e,i);if(!c)return;const u=c.text.slice(0,c.text.indexOf(c.placeholder)),{$from:p}=i.selection,d=p.before(),m=p.after(),f=ne(c.nextNode,d,c.placeholder);r=r.replaceWith(d,m,c.nextNode).setNodeMarkup(d,void 0,l).delete(f+1,f+2),r=r.setSelection(P.near(r.doc.resolve(f+1))),(Y.test(u)||["*","_","~"].includes(u.at(-1)||""))&&r.selection instanceof P&&(((g=r.selection.$cursor)==null?void 0:g.marks())??[]).forEach(I=>{r=r.removeStoredMark(I.type)}),n(r)}const $=E(e=>{let t=null;const o=new b("MILKDOWN_INLINE_SYNC");return new O({key:o,state:{init:()=>null,apply:(n,l,s,a)=>{var f;const r=e.get(_);if(!((f=r.hasFocus)!=null&&f.call(r))||!r.editable||!n.docChanged||n.getMeta(o))return null;const c=T(e,a);if(!c)return null;t&&(cancelAnimationFrame(t),t=null);const{prevNode:u,nextNode:p,text:d}=c,{shouldSyncNode:m}=e.get(h.key);return m({prevNode:u,nextNode:p,ctx:e,tr:n,text:d})&&(t=requestAnimationFrame(()=>{t=null;const{dispatch:S,state:g}=e.get(_);de(e,o,g,S,u.attrs)})),null}}})});A($,{displayName:"Prose<inlineSyncPlugin>",group:"Prose"});const fe=[h,$];L(()=>F.make().config(e=>{e.set(j,document.getElementById("app")),e.get(z).markdownUpdated((t,o)=>{console.log(o)})}).config(q).use(H.filter(e=>!W.includes(e))).use(B.filter(e=>!D.includes(e))).use(G.filter(e=>e!==U)).use(K).use(fe).create());
