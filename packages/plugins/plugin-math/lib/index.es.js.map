{"version":3,"file":"index.es.js","sources":["../src/index.ts"],"sourcesContent":["import { $ctx, $inputRule, $nodeSchema, $remark } from '@milkdown/utils'\nimport type { KatexOptions } from 'katex'\nimport katex from 'katex'\nimport remarkMath from 'remark-math'\n\nimport type { Meta, MilkdownPlugin } from '@milkdown/ctx'\nimport { Fragment } from '@milkdown/prose/model'\nimport { InputRule } from '@milkdown/prose/inputrules'\nimport { expectDomTypeError } from '@milkdown/exception'\nimport { nodeRule } from '@milkdown/prose'\n\nfunction withMeta<T extends MilkdownPlugin>(plugin: T, meta: Partial<Meta> & Pick<Meta, 'displayName'>): T {\n  Object.assign(plugin, {\n    meta: {\n      package: '@milkdown/plugin-math',\n      ...meta,\n    },\n  })\n\n  return plugin\n}\n\n/// This plugin wraps [remark-math](https://www.npmjs.com/package/remark-math).\nexport const remarkMathPlugin = $remark<'remarkMath', undefined>('remarkMath', () => remarkMath)\n\nwithMeta(remarkMathPlugin.plugin, {\n  displayName: 'Remark<remarkMath>',\n})\n\nwithMeta(remarkMathPlugin.options, {\n  displayName: 'RemarkConfig<remarkMath>',\n})\n\nconst mathInlineId = 'math_inline'\n\n/// A slice that contains [options for katex](https://katex.org/docs/options.html).\n/// You can configure katex here.\n/// ```ts\n/// import { katexOptionsCtx } from '@milkdown/plugin-math'\n///\n/// Editor.make()\n///   .config((ctx) => {\n///     ctx.set(katexOptionsCtx.key, { /* some options */ });\n///   })\n/// ```\nexport const katexOptionsCtx = $ctx<KatexOptions, 'katexOptions'>({}, 'katexOptions')\n\nwithMeta(katexOptionsCtx, {\n  displayName: 'Ctx<katexOptions>',\n})\n\n/// Schema for inline math node.\n/// Add support for:\n///\n/// ```markdown\n/// $a^2 + b^2 = c^2$\n/// ```\nexport const mathInlineSchema = $nodeSchema('math_inline', ctx => ({\n  group: 'inline',\n  content: 'text*',\n  inline: true,\n  atom: true,\n  parseDOM: [\n    {\n      tag: `span[data-type=\"${mathInlineId}\"]`,\n      getContent: (dom, schema) => {\n        if (!(dom instanceof HTMLElement))\n          throw expectDomTypeError(dom)\n\n        return Fragment.from(schema.text(dom.dataset.value ?? ''))\n      },\n    },\n  ],\n  toDOM: (node) => {\n    const code: string = node.textContent\n    const dom = document.createElement('span')\n    dom.dataset.type = mathInlineId\n    dom.dataset.value = code\n    katex.render(code, dom, ctx.get(katexOptionsCtx.key))\n\n    return dom\n  },\n  parseMarkdown: {\n    match: node => node.type === 'inlineMath',\n    runner: (state, node, type) => {\n      state.openNode(type)\n        .addText(node.value as string)\n        .closeNode()\n    },\n  },\n  toMarkdown: {\n    match: node => node.type.name === mathInlineId,\n    runner: (state, node) => {\n      state.addNode('inlineMath', undefined, node.textContent)\n    },\n  },\n}))\n\nwithMeta(mathInlineSchema.ctx, {\n  displayName: 'NodeSchemaCtx<mathInline>',\n})\nwithMeta(mathInlineSchema.node, {\n  displayName: 'NodeSchema<mathInline>',\n})\n\n/// Input rule for inline math.\n/// When you type $E=MC^2$, it will create an inline math node.\nexport const mathInlineInputRule = $inputRule(ctx =>\n  nodeRule(/(?:\\$)([^$]+)(?:\\$)$/, mathInlineSchema.type(ctx), {\n    beforeDispatch: ({ tr, match, start }) => {\n      tr.insertText(match[1] ?? '', start + 1)\n    },\n  }),\n)\n\nwithMeta(mathInlineInputRule, {\n  displayName: 'InputRule<mathInline>',\n})\n\nconst mathBlockId = 'math_block'\n/// Schema for block math node.\n/// Add support for:\n///\n/// ```markdown\n/// $$\n/// a^2 + b^2 = c^2\n/// $$\n/// ```\nexport const mathBlockSchema = $nodeSchema('math_block', ctx => ({\n  content: 'text*',\n  group: 'block',\n  marks: '',\n  defining: true,\n  atom: true,\n  isolating: true,\n  attrs: {\n    value: {\n      default: '',\n    },\n  },\n  parseDOM: [\n    {\n      tag: `div[data-type=\"${mathBlockId}\"]`,\n      preserveWhitespace: 'full',\n      getAttrs: (dom) => {\n        return { value: dom.dataset.value ?? '' }\n      },\n    },\n  ],\n  toDOM: (node) => {\n    const code = node.attrs.value\n    const dom = document.createElement('div')\n    dom.dataset.type = mathBlockId\n    dom.dataset.value = code\n    katex.render(code, dom, ctx.get(katexOptionsCtx.key))\n    return dom\n  },\n  parseMarkdown: {\n    match: ({ type }) => type === 'math',\n    runner: (state, node, type) => {\n      const value = node.value as string\n      state.addNode(type, { value })\n    },\n  },\n  toMarkdown: {\n    match: node => node.type.name === mathBlockId,\n    runner: (state, node) => {\n      state.addNode('math', undefined, node.attrs.value)\n    },\n  },\n}))\n\nwithMeta(mathBlockSchema.ctx, {\n  displayName: 'NodeSchemaCtx<mathBlock>',\n})\nwithMeta(mathBlockSchema.node, {\n  displayName: 'NodeSchema<mathBlock>',\n})\n\n/// Input rule for math block.\n/// When you type `$$` and press enter, it will create a math block.\nexport const mathBlockInputRule = $inputRule(ctx => new InputRule(\n  /^\\$\\$\\s$/,\n  (state, _match, start, end) => {\n    const $start = state.doc.resolve(start)\n    if (!$start.node(-1).canReplaceWith($start.index(-1), $start.indexAfter(-1), mathBlockSchema.type(ctx)))\n      return null\n    return state.tr.delete(start, end).setBlockType(start, start, mathBlockSchema.type(ctx))\n  },\n))\nwithMeta(mathBlockInputRule, {\n  displayName: 'InputRule<mathBlock>',\n})\n\n/// All plugins exported by this package.\nexport const math: MilkdownPlugin[] = [remarkMathPlugin, katexOptionsCtx, mathInlineSchema, mathBlockSchema, mathBlockInputRule, mathInlineInputRule].flat()\n"],"names":["withMeta","plugin","meta","remarkMathPlugin","$remark","remarkMath","mathInlineId","katexOptionsCtx","$ctx","mathInlineSchema","$nodeSchema","ctx","dom","schema","expectDomTypeError","Fragment","node","code","katex","state","type","mathInlineInputRule","$inputRule","nodeRule","tr","match","start","mathBlockId","mathBlockSchema","value","mathBlockInputRule","InputRule","_match","end","$start","math"],"mappings":"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"}