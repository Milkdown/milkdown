{"version":3,"file":"index.es.js","sources":["../../src/__internal__/meta.ts","../../src/image-inline/config.ts","../../src/__internal__/helper.ts","../../src/image-inline/component.ts","../../src/image-inline/view.ts","../../src/image-inline/index.ts"],"sourcesContent":["import type { Meta, MilkdownPlugin } from '@milkdown/ctx'\n\nexport function withMeta<T extends MilkdownPlugin>(\n  plugin: T,\n  meta: Partial<Meta> & Pick<Meta, 'displayName'>\n): T {\n  Object.assign(plugin, {\n    meta: {\n      package: '@milkdown-nota/components',\n      ...meta,\n    },\n  })\n\n  return plugin\n}\n","import { $ctx } from '@milkdown/utils'\nimport { html } from 'atomico'\nimport { withMeta } from '../__internal__/meta'\n\nexport interface InlineImageConfig {\n  imageIcon: () => ReturnType<typeof html>\n  uploadButton: () => ReturnType<typeof html>\n  confirmButton: () => ReturnType<typeof html>\n  uploadPlaceholderText: string\n  onUpload: (file: File) => Promise<string>\n}\n\nexport const defaultInlineImageConfig: InlineImageConfig = {\n  imageIcon: () => '🌌',\n  uploadButton: () => html`Upload`,\n  confirmButton: () => html`⏎`,\n  uploadPlaceholderText: '/Paste',\n  onUpload: (file) => Promise.resolve(URL.createObjectURL(file)),\n}\n\nexport const inlineImageConfig = $ctx(\n  defaultInlineImageConfig,\n  'inlineImageConfigCtx'\n)\n\nwithMeta(inlineImageConfig, {\n  displayName: 'Config<image-inline>',\n  group: 'ImageInline',\n})\n","export function defIfNotExists(\n  tagName: string,\n  element: CustomElementConstructor\n) {\n  const current = customElements.get(tagName)\n  if (current == null) {\n    customElements.define(tagName, element)\n    return\n  }\n\n  if (current === element) return\n\n  // eslint-disable-next-line no-console\n  console.warn(`Custom element ${tagName} has been defined before.`)\n}\n","import { c, html, useRef, useState } from 'atomico'\nimport type { Component } from 'atomico'\nimport clsx from 'clsx'\nimport type { InlineImageConfig } from './config'\n\nexport interface Attrs {\n  src: string\n  alt: string\n  title: string\n}\n\nexport type InlineImageComponentProps = Attrs & {\n  setAttr: <T extends keyof Attrs>(attr: T, value: Attrs[T]) => void\n  selected: boolean\n  config: InlineImageConfig\n}\n\nexport const inlineImageComponent: Component<InlineImageComponentProps> = ({\n  src = '',\n  selected = false,\n  alt,\n  title,\n  setAttr,\n  config,\n}) => {\n  const linkInput = useRef<HTMLInputElement>()\n  const [uuid] = useState(crypto.randomUUID())\n  const [focusLinkInput, setFocusLinkInput] = useState(false)\n  const [hidePlaceholder, setHidePlaceholder] = useState(src.length !== 0)\n  const [currentLink, setCurrentLink] = useState(src)\n\n  const onEditLink = (e: InputEvent) => {\n    const target = e.target as HTMLInputElement\n    const value = target.value\n    setHidePlaceholder(value.length !== 0)\n    setCurrentLink(value)\n  }\n\n  const onUpload = async (e: InputEvent) => {\n    const file = (e.target as HTMLInputElement).files?.[0]\n    if (!file) return\n\n    const url = await config?.onUpload(file)\n    if (!url) return\n\n    setAttr?.('src', url)\n    setHidePlaceholder(true)\n  }\n\n  const onConfirmLinkInput = () => {\n    setAttr?.('src', linkInput.current?.value ?? '')\n  }\n\n  const onKeydown = (e: KeyboardEvent) => {\n    if (e.key === 'Enter') onConfirmLinkInput()\n  }\n\n  const preventDrag = (e: Event) => {\n    e.preventDefault()\n    e.stopPropagation()\n  }\n\n  const onClickUploader = (e: PointerEvent) => {\n    e.stopPropagation()\n    e.preventDefault()\n  }\n\n  return html`<host class=${clsx(selected && 'selected', !src && 'empty')}>\n    ${!src\n      ? html`<div class=\"empty-image-inline\">\n          <div class=\"image-icon\">${config?.imageIcon()}</div>\n          <div class=${clsx('link-importer', focusLinkInput && 'focus')}>\n            <input\n              draggable=\"true\"\n              ref=${linkInput}\n              ondragstart=${preventDrag}\n              class=\"link-input-area\"\n              value=${currentLink}\n              oninput=${onEditLink}\n              onkeydown=${onKeydown}\n              onfocus=${() => setFocusLinkInput(true)}\n              onblur=${() => setFocusLinkInput(false)}\n            />\n            <div class=${clsx('placeholder', hidePlaceholder && 'hidden')}>\n              <input\n                class=\"hidden\"\n                id=${uuid}\n                type=\"file\"\n                accept=\"image/*\"\n                onchange=${onUpload}\n              />\n              <label\n                onpointerdown=${onClickUploader}\n                class=\"uploader\"\n                for=${uuid}\n              >\n                ${config?.uploadButton()}\n              </label>\n              <span class=\"text\" onclick=${() => linkInput.current?.focus()}>\n                ${config?.uploadPlaceholderText}\n              </span>\n            </div>\n          </div>\n          <div\n            class=${clsx('confirm', currentLink.length === 0 && 'hidden')}\n            onclick=${() => onConfirmLinkInput()}\n          >\n            ${config?.confirmButton()}\n          </div>\n        </div>`\n      : html`<img class=\"image-inline\" src=${src} alt=${alt} title=${title} />`}\n  </host>`\n}\n\ninlineImageComponent.props = {\n  src: String,\n  alt: String,\n  title: String,\n  selected: Boolean,\n  setAttr: Function,\n  config: Object,\n}\n\nexport const InlineImageElement = c(inlineImageComponent)\n","import { $view } from '@milkdown/utils'\nimport type { NodeViewConstructor } from '@milkdown/prose/view'\nimport { imageSchema } from '@milkdown/preset-commonmark'\nimport type { Node } from '@milkdown/prose/model'\nimport { withMeta } from '../__internal__/meta'\nimport { defIfNotExists } from '../__internal__/helper'\nimport type { InlineImageComponentProps } from './component'\nimport { InlineImageElement } from './component'\nimport { inlineImageConfig } from './config'\n\ndefIfNotExists('milkdown-image-inline', InlineImageElement)\nexport const inlineImageView = $view(\n  imageSchema.node,\n  (ctx): NodeViewConstructor => {\n    return (initialNode, view, getPos) => {\n      const dom = document.createElement(\n        'milkdown-image-inline'\n      ) as HTMLElement & InlineImageComponentProps\n      const config = ctx.get(inlineImageConfig.key)\n      const bindAttrs = (node: Node) => {\n        dom.src = node.attrs.src\n        dom.alt = node.attrs.alt\n        dom.title = node.attrs.title\n      }\n      bindAttrs(initialNode)\n      dom.selected = false\n      dom.setAttr = (attr, value) => {\n        const pos = getPos()\n        if (pos == null) return\n\n        view.dispatch(view.state.tr.setNodeAttribute(pos, attr, value))\n      }\n      dom.config = config\n      return {\n        dom,\n        update: (updatedNode) => {\n          if (updatedNode.type !== initialNode.type) return false\n\n          bindAttrs(updatedNode)\n          return true\n        },\n        stopEvent: (e) => {\n          if (dom.selected && e.target instanceof HTMLInputElement) return true\n\n          return false\n        },\n        selectNode: () => {\n          dom.selected = true\n        },\n        deselectNode: () => {\n          dom.selected = false\n        },\n        destroy: () => {\n          dom.remove()\n        },\n      }\n    }\n  }\n)\n\nwithMeta(inlineImageView, {\n  displayName: 'NodeView<image-inline>',\n  group: 'ImageInline',\n})\n","import type { MilkdownPlugin } from '@milkdown/ctx'\nimport { inlineImageConfig } from './config'\nimport { inlineImageView } from './view'\n\nexport * from './config'\nexport * from './view'\n\nexport const imageInlineComponent: MilkdownPlugin[] = [\n  inlineImageConfig,\n  inlineImageView,\n]\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;AAEgB,SAAA,QAAA,CACd,QACA,IACG,EAAA;AACH,EAAA,MAAA,CAAO,OAAO,MAAQ,EAAA;AAAA,IACpB,IAAM,EAAA,cAAA,CAAA;AAAA,MACJ,OAAS,EAAA;AAAA,KACN,EAAA,IAAA;AAAA,GAEN,CAAA;AAED,EAAO,OAAA,MAAA;AACT;;ACFO,MAAM,wBAA8C,GAAA;AAAA,EACzD,WAAW,MAAM,WAAA;AAAA,EACjB,cAAc,MAAM,IAAA,CAAA,MAAA,CAAA;AAAA,EACpB,eAAe,MAAM,IAAA,CAAA,CAAA,CAAA;AAAA,EACrB,qBAAuB,EAAA,QAAA;AAAA,EACvB,QAAA,EAAU,CAAC,IAAS,KAAA,OAAA,CAAQ,QAAQ,GAAI,CAAA,eAAA,CAAgB,IAAI,CAAC;AAC/D;AAEO,MAAM,iBAAoB,GAAA,IAAA;AAAA,EAC/B,wBAAA;AAAA,EACA;AACF;AAEA,QAAA,CAAS,iBAAmB,EAAA;AAAA,EAC1B,WAAa,EAAA,sBAAA;AAAA,EACb,KAAO,EAAA;AACT,CAAC,CAAA;;AC5Be,SAAA,cAAA,CACd,SACA,OACA,EAAA;AACA,EAAM,MAAA,OAAA,GAAU,cAAe,CAAA,GAAA,CAAI,OAAO,CAAA;AAC1C,EAAA,IAAI,WAAW,IAAM,EAAA;AACnB,IAAe,cAAA,CAAA,MAAA,CAAO,SAAS,OAAO,CAAA;AACtC,IAAA;AAAA;AAGF,EAAA,IAAI,YAAY,OAAS,EAAA;AAGzB,EAAQ,OAAA,CAAA,IAAA,CAAK,CAAkB,eAAA,EAAA,OAAO,CAA2B,yBAAA,CAAA,CAAA;AACnE;;;;;;;;;;;;;;;;;;;;;;ACGO,MAAM,uBAA6D,CAAC;AAAA,EACzE,GAAM,GAAA,EAAA;AAAA,EACN,QAAW,GAAA,KAAA;AAAA,EACX,GAAA;AAAA,EACA,KAAA;AAAA,EACA,OAAA;AAAA,EACA;AACF,CAAM,KAAA;AACJ,EAAA,MAAM,YAAY,MAAyB,EAAA;AAC3C,EAAA,MAAM,CAAC,IAAI,CAAA,GAAI,QAAS,CAAA,MAAA,CAAO,YAAY,CAAA;AAC3C,EAAA,MAAM,CAAC,cAAA,EAAgB,iBAAiB,CAAA,GAAI,SAAS,KAAK,CAAA;AAC1D,EAAA,MAAM,CAAC,eAAiB,EAAA,kBAAkB,IAAI,QAAS,CAAA,GAAA,CAAI,WAAW,CAAC,CAAA;AACvE,EAAA,MAAM,CAAC,WAAA,EAAa,cAAc,CAAA,GAAI,SAAS,GAAG,CAAA;AAElD,EAAM,MAAA,UAAA,GAAa,CAAC,CAAkB,KAAA;AACpC,IAAA,MAAM,SAAS,CAAE,CAAA,MAAA;AACjB,IAAA,MAAM,QAAQ,MAAO,CAAA,KAAA;AACrB,IAAmB,kBAAA,CAAA,KAAA,CAAM,WAAW,CAAC,CAAA;AACrC,IAAA,cAAA,CAAe,KAAK,CAAA;AAAA,GACtB;AAEA,EAAM,MAAA,QAAA,GAAW,CAAO,CAAkB,KAAA,OAAA,CAAA,KAAA,CAAA,EAAA,IAAA,EAAA,aAAA;AAtC5C,IAAA,IAAA,EAAA;AAuCI,IAAA,MAAM,IAAQ,GAAA,CAAA,EAAA,GAAA,CAAA,CAAE,MAA4B,CAAA,KAAA,KAA9B,IAAsC,GAAA,KAAA,CAAA,GAAA,EAAA,CAAA,CAAA,CAAA;AACpD,IAAA,IAAI,CAAC,IAAM,EAAA;AAEX,IAAM,MAAA,GAAA,GAAM,MAAM,MAAA,IAAA,IAAA,GAAA,KAAA,CAAA,GAAA,MAAA,CAAQ,QAAS,CAAA,IAAA,CAAA;AACnC,IAAA,IAAI,CAAC,GAAK,EAAA;AAEV,IAAA,OAAA,IAAA,IAAA,GAAA,KAAA,CAAA,GAAA,OAAA,CAAU,KAAO,EAAA,GAAA,CAAA;AACjB,IAAA,kBAAA,CAAmB,IAAI,CAAA;AAAA,GACzB,CAAA;AAEA,EAAA,MAAM,qBAAqB,MAAM;AAjDnC,IAAA,IAAA,EAAA,EAAA,EAAA;AAkDI,IAAA,OAAA,IAAA,IAAA,GAAA,KAAA,CAAA,GAAA,OAAA,CAAU,KAAO,EAAA,CAAA,EAAA,GAAA,CAAA,EAAA,GAAA,SAAA,CAAU,OAAV,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAAmB,UAAnB,IAA4B,GAAA,EAAA,GAAA,EAAA,CAAA;AAAA,GAC/C;AAEA,EAAM,MAAA,SAAA,GAAY,CAAC,CAAqB,KAAA;AACtC,IAAI,IAAA,CAAA,CAAE,GAAQ,KAAA,OAAA,EAA4B,kBAAA,EAAA;AAAA,GAC5C;AAEA,EAAM,MAAA,WAAA,GAAc,CAAC,CAAa,KAAA;AAChC,IAAA,CAAA,CAAE,cAAe,EAAA;AACjB,IAAA,CAAA,CAAE,eAAgB,EAAA;AAAA,GACpB;AAEA,EAAM,MAAA,eAAA,GAAkB,CAAC,CAAoB,KAAA;AAC3C,IAAA,CAAA,CAAE,eAAgB,EAAA;AAClB,IAAA,CAAA,CAAE,cAAe,EAAA;AAAA,GACnB;AAEA,EAAA,OAAO,mBAAmB,IAAK,CAAA,QAAA,IAAY,YAAY,CAAC,GAAA,IAAO,OAAO,CAAC,CAAA;AAAA,IAAA,EACnE,CAAC,GACC,GAAA,IAAA,CAAA;AAAA,kCAAA,EAC4B,iCAAQ,SAAW,EAAA,CAAA;AAAA,qBAAA,EAChC,IAAK,CAAA,eAAA,EAAiB,cAAkB,IAAA,OAAO,CAAC,CAAA;AAAA;AAAA;AAAA,kBAAA,EAGnD,SAAS;AAAA,0BAAA,EACD,WAAW;AAAA;AAAA,oBAAA,EAEjB,WAAW;AAAA,sBAAA,EACT,UAAU;AAAA,wBAAA,EACR,SAAS;AAAA,sBACX,EAAA,MAAM,iBAAkB,CAAA,IAAI,CAAC;AAAA,qBAC9B,EAAA,MAAM,iBAAkB,CAAA,KAAK,CAAC;AAAA;AAAA,uBAAA,EAE5B,IAAK,CAAA,aAAA,EAAe,eAAmB,IAAA,QAAQ,CAAC,CAAA;AAAA;AAAA;AAAA,mBAAA,EAGpD,IAAI;AAAA;AAAA;AAAA,yBAAA,EAGE,QAAQ;AAAA;AAAA;AAAA,8BAAA,EAGH,eAAe;AAAA;AAAA,oBAAA,EAEzB,IAAI;AAAA;AAAA,gBAAA,EAER,iCAAQ,YAAc,EAAA;AAAA;AAAA,yCAAA,EAEG,MAAG;AAlG9C,IAAA,IAAA,EAAA;AAkGiD,IAAA,OAAA,CAAA,EAAA,GAAA,SAAA,CAAU,YAAV,IAAmB,GAAA,KAAA,CAAA,GAAA,EAAA,CAAA,KAAA,EAAA;AAAA,GAAO,CAAA;AAAA,gBAAA,EACzD,iCAAQ,qBAAqB;AAAA;AAAA;AAAA;AAAA;AAAA,kBAAA,EAK3B,KAAK,SAAW,EAAA,WAAA,CAAY,MAAW,KAAA,CAAA,IAAK,QAAQ,CAAC;AAAA,oBACnD,EAAA,MAAM,oBAAoB;AAAA;AAAA,YAAA,EAElC,iCAAQ,aAAe,EAAA;AAAA;AAAA,cAAA,CAAA,GAG7B,qCAAqC,GAAG,CAAA,KAAA,EAAQ,GAAG,CAAA,OAAA,EAAU,KAAK,CAAK,GAAA,CAAA;AAAA,SAAA,CAAA;AAE/E,CAAA;AAEA,oBAAA,CAAqB,KAAQ,GAAA;AAAA,EAC3B,GAAK,EAAA,MAAA;AAAA,EACL,GAAK,EAAA,MAAA;AAAA,EACL,KAAO,EAAA,MAAA;AAAA,EACP,QAAU,EAAA,OAAA;AAAA,EACV,OAAS,EAAA,QAAA;AAAA,EACT,MAAQ,EAAA;AACV,CAAA;AAEa,MAAA,kBAAA,GAAqB,EAAE,oBAAoB,CAAA;;ACjHxD,cAAA,CAAe,yBAAyB,kBAAkB,CAAA;AACnD,MAAM,eAAkB,GAAA,KAAA;AAAA,EAC7B,WAAY,CAAA,IAAA;AAAA,EACZ,CAAC,GAA6B,KAAA;AAC5B,IAAO,OAAA,CAAC,WAAa,EAAA,IAAA,EAAM,MAAW,KAAA;AACpC,MAAA,MAAM,MAAM,QAAS,CAAA,aAAA;AAAA,QACnB;AAAA,OACF;AACA,MAAA,MAAM,MAAS,GAAA,GAAA,CAAI,GAAI,CAAA,iBAAA,CAAkB,GAAG,CAAA;AAC5C,MAAM,MAAA,SAAA,GAAY,CAAC,IAAe,KAAA;AAChC,QAAI,GAAA,CAAA,GAAA,GAAM,KAAK,KAAM,CAAA,GAAA;AACrB,QAAI,GAAA,CAAA,GAAA,GAAM,KAAK,KAAM,CAAA,GAAA;AACrB,QAAI,GAAA,CAAA,KAAA,GAAQ,KAAK,KAAM,CAAA,KAAA;AAAA,OACzB;AACA,MAAA,SAAA,CAAU,WAAW,CAAA;AACrB,MAAA,GAAA,CAAI,QAAW,GAAA,KAAA;AACf,MAAI,GAAA,CAAA,OAAA,GAAU,CAAC,IAAA,EAAM,KAAU,KAAA;AAC7B,QAAA,MAAM,MAAM,MAAO,EAAA;AACnB,QAAA,IAAI,OAAO,IAAM,EAAA;AAEjB,QAAK,IAAA,CAAA,QAAA,CAAS,KAAK,KAAM,CAAA,EAAA,CAAG,iBAAiB,GAAK,EAAA,IAAA,EAAM,KAAK,CAAC,CAAA;AAAA,OAChE;AACA,MAAA,GAAA,CAAI,MAAS,GAAA,MAAA;AACb,MAAO,OAAA;AAAA,QACL,GAAA;AAAA,QACA,MAAA,EAAQ,CAAC,WAAgB,KAAA;AACvB,UAAA,IAAI,WAAY,CAAA,IAAA,KAAS,WAAY,CAAA,IAAA,EAAa,OAAA,KAAA;AAElD,UAAA,SAAA,CAAU,WAAW,CAAA;AACrB,UAAO,OAAA,IAAA;AAAA,SACT;AAAA,QACA,SAAA,EAAW,CAAC,CAAM,KAAA;AAChB,UAAA,IAAI,GAAI,CAAA,QAAA,IAAY,CAAE,CAAA,MAAA,YAAkB,kBAAyB,OAAA,IAAA;AAEjE,UAAO,OAAA,KAAA;AAAA,SACT;AAAA,QACA,YAAY,MAAM;AAChB,UAAA,GAAA,CAAI,QAAW,GAAA,IAAA;AAAA,SACjB;AAAA,QACA,cAAc,MAAM;AAClB,UAAA,GAAA,CAAI,QAAW,GAAA,KAAA;AAAA,SACjB;AAAA,QACA,SAAS,MAAM;AACb,UAAA,GAAA,CAAI,MAAO,EAAA;AAAA;AACb,OACF;AAAA,KACF;AAAA;AAEJ;AAEA,QAAA,CAAS,eAAiB,EAAA;AAAA,EACxB,WAAa,EAAA,wBAAA;AAAA,EACb,KAAO,EAAA;AACT,CAAC,CAAA;;ACxDM,MAAM,oBAAyC,GAAA;AAAA,EACpD,iBAAA;AAAA,EACA;AACF;;;;"}